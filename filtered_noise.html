<!DOCTYPE html>
<html lang='en'>
    <head>
        <style>
        </style>
        <script>
            window.onload = () => {

                const volumeControl = document.querySelector("#volumeControl");
                volumeControl.addEventListener("input", changeVolume, false);
                const filterControl = document.querySelector("#filterControl");
                filterControl.addEventListener("input", changeFilter, false);
                const filterQ = document.querySelector("#filterQ");
                filterQ.addEventListener("input", changeFilter, false);

                const freqLabel = document.querySelector("#freqLabel");
                const qLabel = document.querySelector("#qLabel");

                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                const gainNode = audioCtx.createGain();
                const noise = createNoise(audioCtx);
                const filterNode = createFilter(audioCtx);

                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                volumeControl.value = 0;
                filterControl.value = 0;
                filterQ.value = 3;

                noise.connect(filterNode);
                filterNode.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                function changeVolume(event) {
                    // see https://www.dr-lex.be/info-stuff/volumecontrols.html
                    const x = event.target.value; //volumeControl.value;
                    gainNode.gain.setValueAtTime(
                        Math.pow(x, 4),
                        audioCtx.currentTime);
                }

                function changeFilter(event) {
                    filterNode.frequency.setValueAtTime(
                        filterControl.value,
                        audioCtx.currentTime,
                    );
                    filterNode.Q.setValueAtTime(
                        filterQ.value,
                        audioCtx.currentTime,
                    );
                    freqLabel.innerHTML = filterControl.value;
                    qLabel.innerHTML = filterQ.value;
                }

                function createNoise(audioContext) {
                    // ref: https://noisehack.com/generate-noise-web-audio-api/
                    const bufferSize = 4 * audioContext.sampleRate; // 4s is long enough to not hear the repeat
                    const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const output = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1; // white noise
                    }

                    const noise = audioContext.createBufferSource();
                    noise.buffer = noiseBuffer;
                    noise.loop = true;
                    noise.start(0);
                    return noise;
                }

                function createFilter( audioContext) {
                    const filter = audioContext.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(0, audioCtx.currentTime);
                    filter.Q = 3.0; // approx 12db/oct ?
                    return filter;
                }
            };
            
        </script>
    </head>
    <body>
        <p>filtered noise</p>
        <p>Volume</p>
        <input type='range' min='0' max='1' step='any' id="volumeControl">
        <p>Filter Frequency</p>
        <p id="freqLabel">0</p>
        <input type='range' min='0' max='10000' step='1' id="filterControl">
        <p>Filter Q</p>
        <p id="qLabel">0</p>
        <input type='range' min='1' max='60' step='0.1' id="filterQ">
    </body>
</html>