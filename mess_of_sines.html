<!DOCTYPE html>
<html lang="en">
 <head>
  <style>
  </style>
  <script>
  window.onload = () => {
    const ctx = new window.AudioContext();

    const mixer = ctx.createGain();
    mixer.gain.value = 0;
    mixer.connect(ctx.destination);    

    const spread = 4; // half notes 
    for( let i = -3; i <= 3; i += 1) {
        const frequency = 220 * Math.pow(2,i*spread/12);
        console.log(frequency);
        const vco = createVCO(ctx, frequency);
        vco.connect(mixer);
    }

    const volumeControl = document.querySelector('#volumeControl');
    volumeControl.addEventListener('input', changeVolume, false);
    changeVolume({target: { value: 0 }});
    volumeControl.value = 0;
    function changeVolume(event) {
        // see https://www.dr-lex.be/info-stuff/volumecontrols.html
        const x = event.target.value;
        mixer.gain.setValueAtTime(
            Math.pow(x, 4),
            ctx.currentTime);
        volumeLabel.innerHTML = Number.parseFloat(x).toFixed(2);
    }
  }

  const createVCO = (ctx, freq) => {
    const vco = ctx.createOscillator();
    vco.frequency.value = freq;
    vco.type = 'sine';
    vco.start();

    const lfo = ctx.createOscillator();
    const range = 500;
    const frequency = freq / (Math.random() * range + (10000 + range / 2 ));
    console.log(frequency);
    lfo.frequency.value = frequency;
    lfo.type = 'sine';
    lfo.start();

    const vca = ctx.createGain();
    lfo.connect(vca.gain);
    vco.connect(vca);

    return vca;
  };

  </script>
 </head>
<body>
  <p>detuned oscillators - chordal wash</p>
  <p>inspired by <a href="https://github.com/sensorium/Mozzi/blob/master/examples/02.Control/Control_Oscil_Wash/Control_Oscil_Wash.ino">this example</a> from the Mozzi Arduino library</p>
  <p>Master volume</p>
  <p id="volumeLabel">0</p>
  <input type="range" min="0" max="1" step="any" id="volumeControl">
</body>
</html>
